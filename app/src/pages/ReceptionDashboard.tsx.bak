import { useState, useEffect, useRef } from 'react';
import { useTranslation } from 'react-i18next';
import { useNavigate } from 'react-router-dom';
import { format } from 'date-fns';
import {
    Users,
    UserPlus,
    Calendar,
    Clock,
    CheckCircle,
    XCircle,
    Dumbbell,
    CheckSquare,
    XSquare,
    MessageSquare,
    Save,
    X
} from 'lucide-react';
import { supabase } from '../lib/supabase';
import AddStudentForm from '../components/AddStudentForm';
import AddPTSubscriptionForm from '../components/AddPTSubscriptionForm';
import toast from 'react-hot-toast';

export default function ReceptionDashboard() {
    const { t, i18n } = useTranslation();
    const navigate = useNavigate();
    const [currentTime, setCurrentTime] = useState(new Date());

    // Modals State
    const [showAddStudent, setShowAddStudent] = useState(false);
    const [showAddPT, setShowAddPT] = useState(false);

    // Note Editing State
    const [editingNoteId, setEditingNoteId] = useState<string | null>(null);
    const [noteText, setNoteText] = useState('');

    // Class Attendance State
    const [todaysClasses, setTodaysClasses] = useState<any[]>([]);
    const [loadingClasses, setLoadingClasses] = useState(true);
    const [recentCheckIns, setRecentCheckIns] = useState<any[]>([]);

    // Coach Attendance State
    const [coachesList, setCoachesList] = useState<any[]>([]);
    const [loadingCoaches, setLoadingCoaches] = useState(true);
    const [refreshTrigger, setRefreshTrigger] = useState(0);

    // PT Attendance State
    const [ptList, setPtList] = useState<any[]>([]);
    const [loadingPt, setLoadingPt] = useState(true);

    // Self Check-In State
    const [myCoachId, setMyCoachId] = useState<string | null>(null);
    const [isCheckedIn, setIsCheckedIn] = useState(false);
    const [checkInTime, setCheckInTime] = useState<string | null>(null);
    const [elapsedTime, setElapsedTime] = useState(0);

    // Refs for stale closures
    const myCoachIdRef = useRef<string | null>(null);
    const isCheckedInRef = useRef(false);

    useEffect(() => {
        myCoachIdRef.current = myCoachId;
    }, [myCoachId]);

    useEffect(() => {
        isCheckedInRef.current = isCheckedIn;
    }, [isCheckedIn]);

    // DEBUG STATES
    const [debugError, setDebugError] = useState<string>('');
    const [debugAuth, setDebugAuth] = useState<string>('Checking...');

    useEffect(() => {
        // Check Auth and Initialize Self
        const initializeSelf = async () => {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                setDebugAuth('Logged In: ' + user.id.slice(0, 5));

                // 1. Try to find a coach record for this user
                const { data: coachData } = await supabase
                    .from('coaches')
                    .select('id')
                    .eq('profile_id', user.id)
                    .maybeSingle();

                if (coachData) {
                    setMyCoachId(coachData.id);
                    // 2. Check today's attendance
                    const todayStr = format(new Date(), 'yyyy-MM-dd');
                    const { data: attendance } = await supabase
                        .from('coach_attendance')
                        .select('*')
                        .eq('coach_id', coachData.id)
                        .eq('date', todayStr)
                        .maybeSingle();

                    if (attendance) {
                        const start = new Date(attendance.check_in_time);
                        if (!attendance.check_out_time && attendance.check_in_time) {
                            setIsCheckedIn(true);
                            setCheckInTime(format(start, 'HH:mm:ss'));
                            setElapsedTime(Math.floor((new Date().getTime() - start.getTime()) / 1000));

                            // Restore timer from local storage if needed or just sync with server time
                            localStorage.setItem(`receptionCheckInStart_${todayStr}`, JSON.stringify({
                                timestamp: start.getTime(),
                                recordId: attendance.id
                            }));
                        } else if (attendance.check_out_time) {
                            setIsCheckedIn(false);
                        }
                    }
                }
            } else {
                setDebugAuth('No User');
            }
        };

        initializeSelf();

        const timer = setInterval(() => setCurrentTime(new Date()), 1000);
        fetchRecentCheckIns();
        fetchCoachesStatus();
        fetchPtStatus(); // Fetch PTs

        // Realtime Subscription for Student Attendance
        const studentAttendanceSub = supabase
            .channel('public:student_attendance')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'student_attendance' }, () => {
                fetchRecentCheckIns();
                fetchTodaysClasses(); // Auto refresh class list on changes
            })
            .subscribe();

        // Realtime Subscription for Coach Attendance
        const coachAttendanceSub = supabase
            .channel('public:coach_attendance')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'coach_attendance' }, () => {
                fetchCoachesStatus();
            })
            .subscribe();

        // Realtime Subscription for PT Attendance
        const ptAttendanceSub = supabase
            .channel('public:pt_attendance')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'pt_attendance' }, () => {
                fetchPtStatus();
            })
            .subscribe();

        return () => {
            clearInterval(timer);
            supabase.removeChannel(studentAttendanceSub);
            supabase.removeChannel(coachAttendanceSub);
            supabase.removeChannel(ptAttendanceSub);
        };
    }, []);

    // --- Class Attendance Logic ---
    const fetchTodaysClasses = async () => {
        try {
            if (todaysClasses.length === 0) setLoadingClasses(true);
            const todayIdx = new Date().getDay(); // 0 = Sunday, 6 = Saturday
            const dayMap = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const todayDay = dayMap[todayIdx];
            const dateStr = format(new Date(), 'yyyy-MM-dd');

            console.log('Fetching classes for:', todayDay);

            // 1. Fetch Students scheduled for today
            const { data: students, error: studentsError } = await supabase
                .from('students')
                .select('id, full_name, training_schedule, training_days, coaches(full_name)')
                .contains('training_days', [todayDay]);

            if (studentsError) {
                console.error('Error fetching students:', studentsError);
                return;
            }

            // 2. Fetch Attendance for today
            const { data: attendance, error: attendanceError } = await supabase
                .from('student_attendance')
                .select('*')
                .eq('date', dateStr);

            if (attendanceError) {
                console.error('Error fetching attendance:', attendanceError);
            }

            // 3. Merge Data
            const merged = (students || []).map(student => {
                const record = attendance?.find(a => a.student_id === student.id);
                const todaySchedule = student.training_schedule?.find((s: any) => s.day === todayDay);

                let status = 'pending';
                if (record) {
                    if (record.status === 'absent') status = 'absent';
                    else if (record.check_out_time) status = 'completed';
                    else status = 'present';
                }

                return {
                    ...student,
                    scheduledStart: todaySchedule?.start || '',
                    scheduledEnd: todaySchedule?.end || '',
                    attendanceId: record?.id,
                    status: status,
                    note: record?.note || '',
                    checkInTime: record?.check_in_time,
                    checkOutTime: record?.check_out_time
                };
            }).sort((a, b) => {
                if (a.scheduledStart !== b.scheduledStart) return a.scheduledStart.localeCompare(b.scheduledStart);
                return a.full_name.localeCompare(b.full_name);
            });

            console.log('Classes Merged:', merged);
            setTodaysClasses(merged);
        } catch (error) {
            console.error('Error fetching classes:', error);
        } finally {
            setLoadingClasses(false);
        }
    };

    useEffect(() => {
        fetchTodaysClasses();
        const interval = setInterval(fetchTodaysClasses, 60000);
        return () => clearInterval(interval);
    }, [refreshTrigger]);

    // Timer Logic for Self Check-In
    useEffect(() => {
        let interval: any;
        if (isCheckedIn) {
            interval = setInterval(() => {
                const today = format(new Date(), 'yyyy-MM-dd');
                const startTime = localStorage.getItem(`receptionCheckInStart_${today}`);
                if (startTime) {
                    const params = JSON.parse(startTime);
                    const now = new Date().getTime();
                    setElapsedTime(Math.floor((now - params.timestamp) / 1000));
                }
            }, 1000);
        } else {
            setElapsedTime(0);
        }
        return () => clearInterval(interval);
    }, [isCheckedIn]);

    // --- Data Fetching ---
    const fetchRecentCheckIns = async () => {
        try {
            const today = format(new Date(), 'yyyy-MM-dd');
            const { data } = await supabase
                .from('student_attendance')
                .select('*, students(full_name)')
                .eq('date', today)
                .order('check_in_time', { ascending: false })
                .limit(20);

            setRecentCheckIns(data || []);
        } catch (error) {
            console.error('Error fetching recent check-ins:', error);
        }
    };

    const fetchCoachesStatus = async () => {
        try {
            if (coachesList.length === 0) setLoadingCoaches(true);
            const today = format(new Date(), 'yyyy-MM-dd');

            // 1. Get all coaches
            const { data: coaches, error: coachesError } = await supabase
                .from('coaches')
                .select('id, full_name, avatar_url')
                .order('full_name');

            if (coachesError) throw coachesError;
            if (!coaches) return;

            // 2. Get today's attendance
            const { data: attendance, error: attendanceError } = await supabase
                .from('coach_attendance')
                .select('*')
                .eq('date', today);

            if (attendanceError) throw attendanceError;

            // 3. Merge data
            // Use refs to avoid stale closures
            const currentMyCoachId = myCoachIdRef.current;
            const currentIsCheckedIn = isCheckedInRef.current;

            const merged = coaches.map(coach => {
                const record = attendance?.find(a => a.coach_id === coach.id);

                let status = 'pending';
                let checkIn = record?.check_in_time;
                let checkOut = record?.check_out_time;

                if (record) {
                    if (record.status === 'absent') status = 'absent';
                    else if (record.check_out_time) status = 'completed';
                    else status = 'present';
                }

                // FORCE LOCAL STATE for current user to prevent flickering
                if (coach.id === currentMyCoachId && currentIsCheckedIn) {
                    status = 'present';
                    if (!checkIn) checkIn = new Date().toISOString(); // Fallback if record not found yet
                }

                return {
                    ...coach,
                    status: status,
                    note: record?.note || '',
                    checkInTime: checkIn,
                    checkOutTime: checkOut,
                    attendanceId: record?.id
                };
            });

            setCoachesList(merged);
        } catch (error) {
            console.error('Error fetching coaches status:', error);
            // Don't toast here to avoid spamming the user if it loops
        } finally {
            setLoadingCoaches(false);
        }
    };

    const fetchPtStatus = async () => {
        try {
            if (ptList.length === 0) setLoadingPt(true);
            const today = format(new Date(), 'yyyy-MM-dd');

            // 1. Get Active Subscriptions
            const { data: subs, error: subsError } = await supabase
                .from('pt_subscriptions')
                .select('*, students(full_name), coaches(full_name)')
                .eq('status', 'active')
                .gt('sessions_remaining', 0); // Only show if sessions remaining

            if (subsError) throw subsError;
            if (!subs) return;

            // 2. Get Today's PT Attendance
            const { data: attendance, error: attendanceError } = await supabase
                .from('pt_attendance')
                .select('*')
                .eq('date', today);

            if (attendanceError) throw attendanceError;

            // 3. Merge
            const merged = subs.map(sub => {
                const record = attendance?.find(a => a.pt_subscription_id === sub.id);

                let displayName = sub.student_name; // Guest Name (if any)
                if (sub.students && sub.students.full_name) {
                    displayName = sub.students.full_name; // Registered Name overrides/is preferred
                }

                let status = 'pending';
                if (record) {
                    if (record.status === 'absent') status = 'absent';
                    else if (record.check_out_time) status = 'completed';
                    else status = 'present';
                }

                return {
                    ...sub,
                    displayName,
                    status,
                    attendanceId: record?.id,
                    checkInTime: record?.check_in_time,
                    checkOutTime: record?.check_out_time,
                    note: record?.note,
                    coachName: sub.coaches?.full_name
                };
            }).sort((a, b) => {
                // Sort by status (present > pending > completed)
                if (a.status === 'present' && b.status !== 'present') return -1;
                if (a.status !== 'present' && b.status === 'present') return 1;
                return a.displayName.localeCompare(b.displayName);
            });

            setPtList(merged);
        } catch (error) {
            console.error('Error fetching PT status:', error);
        } finally {
            setLoadingPt(false);
        }
    };

    // --- Actions ---
    const fetchPtStatus = async () => {
        try {
            if (ptList.length === 0) setLoadingPt(true);
            const today = format(new Date(), 'yyyy-MM-dd');

            // 1. Get Active Subscriptions
            const { data: subs, error: subsError } = await supabase
                .from('pt_subscriptions')
                .select('*, students(full_name), coaches(full_name)')
                .eq('status', 'active')
                .gt('sessions_remaining', 0); // Only show if sessions remaining

            if (subsError) throw subsError;
            if (!subs) return;

            // 2. Get Today's PT Attendance
            const { data: attendance, error: attendanceError } = await supabase
                .from('pt_attendance')
                .select('*')
                .eq('date', today);

            if (attendanceError) throw attendanceError;

            // 3. Merge
            const merged = subs.map(sub => {
                const record = attendance?.find(a => a.pt_subscription_id === sub.id);

                let displayName = sub.student_name; // Guest Name (if any)
                if (sub.students && sub.students.full_name) {
                    displayName = sub.students.full_name; // Registered Name overrides/is preferred
                }

                let status = 'pending';
                if (record) {
                    if (record.status === 'absent') status = 'absent';
                    else if (record.check_out_time) status = 'completed';
                    else status = 'present';
                }

                return {
                    ...sub,
                    displayName,
                    status,
                    attendanceId: record?.id,
                    checkInTime: record?.check_in_time,
                    checkOutTime: record?.check_out_time,
                    note: record?.note,
                    coachName: sub.coaches?.full_name
                };
            }).sort((a, b) => {
                if (a.status === 'present' && b.status !== 'present') return -1;
                if (a.status !== 'present' && b.status === 'present') return 1;
                return (a.displayName || '').localeCompare(b.displayName || '');
            });

            setPtList(merged);
        } catch (error) {
            console.error('Error fetching PT status:', error);
        } finally {
            setLoadingPt(false);
        }
    };

    const handlePtStatusUpdate = async (subscriptionId: string, currentSessionsRemaining: number, newStatus: 'present' | 'absent' | 'completed') => {
        try {
            const today = format(new Date(), 'yyyy-MM-dd');

            // Find subscription to verify
            const { data: sub } = await supabase
                .from('pt_subscriptions')
                .select('sessions_remaining')
                .eq('id', subscriptionId)
                .single();

            if (!sub) return toast.error('Subscription not found');

            // Logic for Check In (Present)
            if (newStatus === 'present') {
                if (sub.sessions_remaining <= 0) {
                    return toast.error('No sessions remaining!');
                }

                // 1. Create Attendance Record
                const { error: attError } = await supabase
                    .from('pt_attendance')
                    .insert({
                        pt_subscription_id: subscriptionId,
                        date: today,
                        status: 'present',
                        check_in_time: new Date().toISOString()
                    });

                if (attError) throw attError;

                // 2. Deduct Session
                const { error: subError } = await supabase
                    .from('pt_subscriptions')
                    .update({ sessions_remaining: sub.sessions_remaining - 1 })
                    .eq('id', subscriptionId);

                if (subError) throw subError;

                toast.success('PT Session Started');
            }
            // Logic for Check Out (Completed)
            else if (newStatus === 'completed') {
                // Find today's attendance record
                const { data: record } = await supabase
                    .from('pt_attendance')
                    .select('id')
                    .eq('pt_subscription_id', subscriptionId)
                    .eq('date', today)
                    .single();

                if (record) {
                    await supabase
                        .from('pt_attendance')
                        .update({
                            status: 'completed',
                            check_out_time: new Date().toISOString()
                        })
                        .eq('id', record.id);
                    toast.success('Session Completed');
                }
            }

            fetchPtStatus();
            // Refresh dashboard stats or other queries if needed
        } catch (error) {
            console.error('PT Status Switch Error:', error);
            toast.error(t('common.error'));
        }
    };

    // --- Actions ---
    const handleStatusUpdate = async (studentId: string, newStatus: 'present' | 'absent') => {
        try {
            const today = format(new Date(), 'yyyy-MM-dd');

            // Check existing
            const { data: existing } = await supabase
                .from('student_attendance')
                .select('*')
                .eq('student_id', studentId)
                .eq('date', today)
                .maybeSingle();

            const payload: any = {
                student_id: studentId,
                date: today,
                status: newStatus
            };

            if (newStatus === 'present') {
                // Only set check_in_time if not already set or switching from absent
                if (!existing || !existing.check_in_time) {
                    payload.check_in_time = new Date().toISOString();
                }
                // Reset check_out_time if we mark as present (re-opening session)
                payload.check_out_time = null;
            } else {
                // Absent
                payload.check_in_time = null;
                payload.check_out_time = null;
            }

            if (existing) {
                const { error } = await supabase
                    .from('student_attendance')
                    .update(payload)
                    .eq('id', existing.id);
                if (error) throw error;
            } else {
                const { error } = await supabase
                    .from('student_attendance')
                    .insert(payload);
                if (error) throw error;
            }

            toast.success(newStatus === 'present' ? 'Marked as Present' : 'Marked as Absent');
            fetchRecentCheckIns();
            fetchTodaysClasses();
        } catch (error) {
            console.error('Status update error:', error);
            toast.error(t('common.error') || 'An error occurred');
        }
    };

    const handleSaveNote = async (studentId: string) => {
        try {
            const today = format(new Date(), 'yyyy-MM-dd');

            const { data: existing } = await supabase
                .from('student_attendance')
                .select('*')
                .eq('student_id', studentId)
                .eq('date', today)
                .maybeSingle();

            if (existing) {
                await supabase
                    .from('student_attendance')
                    .update({ note: noteText })
                    .eq('id', existing.id);
            } else {
                await supabase
                    .from('student_attendance')
                    .insert({
                        student_id: studentId,
                        date: today,
                        note: noteText,
                        status: 'pending'
                    });
            }
            setEditingNoteId(null);
            fetchTodaysClasses();
            toast.success(t('reception.noteSaved'));
        } catch (error) {
            console.error('Save note error:', error);
        }
    };



    const handleStaffStatusUpdate = async (coachId: string, newStatus: 'present' | 'absent') => {
        try {
            const today = format(new Date(), 'yyyy-MM-dd');

            // Check existing
            const { data: existing } = await supabase
                .from('coach_attendance')
                .select('*')
                .eq('coach_id', coachId)
                .eq('date', today)
                .maybeSingle();

            const payload: any = {
                coach_id: coachId,
                date: today,
                status: newStatus
            };

            if (newStatus === 'present') {
                if (!existing || !existing.check_in_time) {
                    payload.check_in_time = new Date().toISOString();
                }
                payload.check_out_time = null;
            } else {
                payload.check_in_time = null;
                payload.check_out_time = null;
            }

            if (existing) {
                const { error } = await supabase
                    .from('coach_attendance')
                    .update(payload)
                    .eq('id', existing.id);
                if (error) throw error;
            } else {
                const { error } = await supabase
                    .from('coach_attendance')
                    .insert(payload);
                if (error) throw error;
            }

            toast.success(newStatus === 'present' ? 'Staff Present' : 'Staff Absent');
            fetchCoachesStatus();
        } catch (error) {
            console.error('Staff status error:', error);
            toast.error(t('common.error') || 'An error occurred');
        }
    };

    const handleSaveStaffNote = async (coachId: string) => {
        try {
            const today = format(new Date(), 'yyyy-MM-dd');

            const { data: existing } = await supabase
                .from('coach_attendance')
                .select('*')
                .eq('coach_id', coachId)
                .eq('date', today)
                .maybeSingle();

            if (existing) {
                await supabase
                    .from('coach_attendance')
                    .update({ note: noteText })
                    .eq('id', existing.id);
            } else {
                await supabase
                    .from('coach_attendance')
                    .insert({
                        coach_id: coachId,
                        date: today,
                        note: noteText,
                        status: 'pending'
                    });
            }

            toast.success('Note saved');
            setEditingNoteId(null);
            setNoteText('');
            fetchCoachesStatus();
        } catch (error) {
            console.error('Save staff note error:', error);
            toast.error('Failed to save note');
        }
    };

    // --- Self Check-In Handlers ---
    const handleSelfCheckIn = async () => {
        if (!myCoachId) return toast.error('You are not linked to a staff profile');
        const now = new Date();
        const todayStr = format(now, 'yyyy-MM-dd');

        try {
            const { data, error } = await supabase
                .from('coach_attendance')
                .upsert({
                    coach_id: myCoachId,
                    date: todayStr,
                    check_in_time: now.toISOString(),
                    status: 'present'
                }, { onConflict: 'coach_id,date' })
                .select().single();

            if (error) throw error;

            setIsCheckedIn(true);
            setCheckInTime(format(now, 'HH:mm:ss'));
            localStorage.setItem(`receptionCheckInStart_${todayStr}`, JSON.stringify({ timestamp: now.getTime(), recordId: data.id }));

            // Optimistic Update
            console.log('Optimistic Update Triggered for:', myCoachId);
            setCoachesList(prev => prev.map(c => {
                if (c.id === myCoachId) {
                    console.log('Found coach in list, updating status to present');
                    return { ...c, status: 'present', checkInTime: now.toISOString() };
                }
                return c;
            }));

            toast.success('You are Checked In!');

            // Re-fetch after a short delay to ensure DB propagation
            setTimeout(() => {
                console.log('Delayed fetch triggered');
                fetchCoachesStatus();
            }, 1000);
        } catch (error: any) {
            console.error('Self check-in error:', error);
            toast.error(error.message || 'Check-in failed');
        }
    };

    const handleSelfCheckOut = async () => {
        if (!myCoachId) return;
        const now = new Date();
        const today = format(now, 'yyyy-MM-dd');
        const savedStart = localStorage.getItem(`receptionCheckInStart_${today}`);

        try {
            if (savedStart) {
                const { recordId } = JSON.parse(savedStart);
                await supabase.from('coach_attendance')
                    .update({ check_out_time: now.toISOString(), status: 'completed' }) // Or keep as present? completed implies done for day
                    .eq('id', recordId);
            } else {
                // Fallback if local storage missing, try to find active record
                const { data: record } = await supabase.from('coach_attendance')
                    .select('id')
                    .eq('coach_id', myCoachId)
                    .eq('date', today)
                    .is('check_out_time', null)
                    .maybeSingle();

                if (record) {
                    await supabase.from('coach_attendance')
                        .update({ check_out_time: now.toISOString(), status: 'completed' })
                        .eq('id', record.id);
                }
            }

            setIsCheckedIn(false);
            setCheckInTime(null);
            setElapsedTime(0);
            localStorage.removeItem(`receptionCheckInStart_${today}`);

            // Optimistic Update
            console.log('Optimistic Update Triggered (Check-out) for:', myCoachId);
            setCoachesList(prev => prev.map(c => {
                if (c.id === myCoachId) {
                    return { ...c, status: 'completed', checkOutTime: now.toISOString() };
                }
                return c;
            }));

            toast.success('You are Checked Out!');
            setTimeout(() => {
                fetchCoachesStatus();
            }, 1000);
        } catch (error) {
            console.error('Self check-out error:', error);
            toast.error('Check-out failed');
        }
    };

    const formatTimer = (seconds: number) => {
        if (isNaN(seconds) || seconds < 0) return '00:00:00';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    };

    return (
        <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
            {/* Header */}
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div>
                    <h1 className="text-4xl font-extrabold premium-gradient-text uppercase tracking-tight">
                        {t('reception.dashboard') || 'Reception Dashboard'}
                    </h1>
                    <p className="text-white/60 mt-2 font-bold uppercase tracking-wide">
                        {format(currentTime, 'EEEE, dd MMMM yyyy')} â€¢ {format(currentTime, 'HH:mm:ss')}
                    </p>
                </div>

                {/* Self Check-In Widget */}
                {myCoachId && (
                    <div className="flex items-center gap-4 bg-white/5 p-4 rounded-2xl border border-white/10">
                        <div className="flex flex-col items-end">
                            <span className="text-[10px] font-black text-white/40 uppercase tracking-widest mb-1">My Duty Status</span>
                            {isCheckedIn ? (
                                <span className="text-2xl font-black text-white font-mono">{formatTimer(elapsedTime)}</span>
                            ) : (
                                <span className="text-sm font-bold text-white/40">Not Checked In</span>
                            )}
                        </div>

                        <button
                            onClick={isCheckedIn ? handleSelfCheckOut : handleSelfCheckIn}
                            className={`w-14 h-14 rounded-xl flex items-center justify-center transition-all ${isCheckedIn ? 'bg-rose-500 text-white shadow-lg shadow-rose-500/20 hover:bg-rose-600' : 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20 hover:bg-emerald-600'}`}
                            title={isCheckedIn ? "Check Out" : "Check In"}
                        >
                            {isCheckedIn ? <XCircle className="w-8 h-8" /> : <Clock className="w-8 h-8" />}
                        </button>
                    </div>
                )}
            </div>

            {/* Quick Actions */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button
                    onClick={() => setShowAddStudent(true)}
                    className="glass-card p-6 rounded-3xl border border-white/10 hover:border-primary/50 group transition-all text-left relative overflow-hidden"
                >
                    <div className="absolute right-0 top-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                        <UserPlus className="w-24 h-24 text-primary" />
                    </div>
                    <div className="relative z-10">
                        <div className="w-12 h-12 rounded-2xl bg-primary/20 text-primary flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                            <UserPlus className="w-6 h-6" />
                        </div>
                        <h3 className="text-xl font-black text-white uppercase tracking-tight mb-1">
                            {t('students.addStudent') || 'Add Student'}
                        </h3>
                        <p className="text-xs text-white/50 font-bold uppercase tracking-wider">
                            Register new gymnast
                        </p>
                    </div>
                </button>

                <button
                    onClick={() => setShowAddPT(true)}
                    className="glass-card p-6 rounded-3xl border border-white/10 hover:border-accent/50 group transition-all text-left relative overflow-hidden"
                >
                    <div className="absolute right-0 top-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                        <Dumbbell className="w-24 h-24 text-accent" />
                    </div>
                    <div className="relative z-10">
                        <div className="w-12 h-12 rounded-2xl bg-accent/20 text-accent flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                            <Dumbbell className="w-6 h-6" />
                        </div>
                        <h3 className="text-xl font-black text-white uppercase tracking-tight mb-1">
                            {t('students.addSubscription') || 'Add Subscription'}
                        </h3>
                        <p className="text-xs text-white/50 font-bold uppercase tracking-wider">
                            New Private Training
                        </p>
                    </div>
                </button>

                <button
                    onClick={() => navigate('/schedule')}
                    className="glass-card p-6 rounded-3xl border border-white/10 hover:border-purple-500/50 group transition-all text-left relative overflow-hidden"
                >
                    <div className="absolute right-0 top-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                        <Calendar className="w-24 h-24 text-purple-500" />
                    </div>
                    <div className="relative z-10">
                        <div className="w-12 h-12 rounded-2xl bg-purple-500/20 text-purple-500 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                            <Calendar className="w-6 h-6" />
                        </div>
                        <h3 className="text-xl font-black text-white uppercase tracking-tight mb-1">
                            {t('common.schedule') || 'View Schedule'}
                        </h3>
                        <p className="text-xs text-white/50 font-bold uppercase tracking-wider">
                            Check classes timing
                        </p>
                    </div>
                </button>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8">
                {/* Student Attendance Section */}
                <div className="glass-card rounded-[2.5rem] border border-white/10 p-8 flex flex-col h-[600px]">
                    <div className="flex items-center justify-between mb-8">
                        <h2 className="text-2xl font-black text-white uppercase tracking-tight flex items-center gap-3">
                            <Users className="w-6 h-6 text-primary" />
                            {t('reception.studentAttendance') || 'Student Attendance'}
                        </h2>
                        <div className="flex items-center gap-2">
                            <span className="px-3 py-1 bg-white/5 text-xs font-bold uppercase tracking-wider rounded-lg text-white/50">
                                {todaysClasses.filter(c => c.status === 'present' || c.status === 'completed').length} / {todaysClasses.length} Present
                            </span>
                        </div>
                    </div>

                    {/* Class List Table */}
                    <div className="flex-1 overflow-y-auto custom-scrollbar">
                        {loadingClasses ? (
                            <div className="text-center py-20 text-white/30 uppercase tracking-widest font-bold">
                                <Users className="w-12 h-12 mx-auto mb-4 animate-pulse opacity-50" />
                                Loading Today's Classes...
                            </div>
                        ) : todaysClasses.length === 0 ? (
                            <div className="text-center py-20 opacity-30">
                                <Calendar className="w-12 h-12 mx-auto mb-4" />
                                <p className="uppercase tracking-widest font-bold">No Classes Scheduled Today</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {todaysClasses.map(student => (
                                    <div key={student.id}
                                        className={`flex items-center justify-between p-4 rounded-2xl border transition-all 
                                            ${student.status === 'present' ? 'bg-emerald-500/10 border-emerald-500/20' :
                                                student.status === 'completed' ? 'bg-white/5 border-white/5 opacity-60' :
                                                    student.status === 'absent' ? 'bg-rose-500/5 border-rose-500/10' :
                                                        'bg-white/5 border-white/10'}`}
                                    >
                                        <div className="flex items-center gap-4">
                                            <div className={`w-14 h-14 rounded-xl flex flex-col items-center justify-center font-black 
                                                ${student.status === 'present' ? 'bg-emerald-500/20 text-emerald-400' :
                                                    student.status === 'absent' ? 'bg-rose-500/20 text-rose-400' :
                                                        'bg-white/10 text-white/40'}`}>
                                                <span className="text-lg leading-none">{student.scheduledStart ? format(new Date(`2000-01-01T${student.scheduledStart}`), 'HH:mm') : '--'}</span>
                                            </div>
                                            <div>
                                                <p
                                                    onClick={() => navigate(`/students/${student.id}`)}
                                                    className="font-bold text-white text-lg hover:text-primary cursor-pointer transition-colors"
                                                >
                                                    {student.full_name}
                                                </p>
                                                <div className="flex items-center gap-3 text-xs font-bold uppercase tracking-wider text-white/40">
                                                    <span className="flex items-center gap-1">
                                                        <Users className="w-3 h-3" />
                                                        {Array.isArray(student.coaches)
                                                            ? (student.coaches[0]?.full_name || 'No Coach')
                                                            : (student.coaches?.full_name || 'No Coach')}
                                                    </span>
                                                    {student.status === 'present' && (
                                                        <span className="text-emerald-400 flex items-center gap-1">
                                                            <CheckCircle className="w-3 h-3" /> Present
                                                        </span>
                                                    )}
                                                    {student.status === 'absent' && (
                                                        <span className="text-rose-400 flex items-center gap-1">
                                                            <XCircle className="w-3 h-3" /> Absent
                                                        </span>
                                                    )}
                                                </div>
                                                {/* Note Display */}
                                                {student.note && editingNoteId !== student.id && (
                                                    <div className="mt-2 text-xs text-yellow-400/80 bg-yellow-400/10 px-2 py-1 rounded-md inline-flex items-center gap-1">
                                                        <MessageSquare className="w-3 h-3" />
                                                        {student.note}
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="flex items-center gap-2">
                                            {/* Note Input Area */}
                                            {editingNoteId === student.id ? (
                                                <div className="flex items-center gap-2 mr-2 animate-in fade-in slide-in-from-right-4">
                                                    <input
                                                        autoFocus
                                                        type="text"
                                                        value={noteText}
                                                        onChange={(e) => setNoteText(e.target.value)}
                                                        placeholder="Add a note..."
                                                        className="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-primary/50 w-48"
                                                        onKeyDown={(e) => e.key === 'Enter' && handleSaveNote(student.id)}
                                                    />
                                                    <button
                                                        onClick={() => handleSaveNote(student.id)}
                                                        className="p-2 bg-emerald-500/20 text-emerald-400 rounded-lg hover:bg-emerald-500/30"
                                                    >
                                                        <Save className="w-4 h-4" />
                                                    </button>
                                                    <button
                                                        onClick={() => setEditingNoteId(null)}
                                                        className="p-2 bg-white/5 text-white/40 rounded-lg hover:bg-white/10"
                                                    >
                                                        <X className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            ) : (
                                                <button
                                                    onClick={() => {
                                                        setEditingNoteId(student.id);
                                                        setNoteText(student.note || '');
                                                    }}
                                                    className={`p-3 rounded-xl transition-all ${student.note ? 'text-yellow-400 bg-yellow-400/10' : 'text-white/20 bg-white/5 hover:text-white/60'}`}
                                                    title="Add Note"
                                                >
                                                    <MessageSquare className="w-5 h-5" />
                                                </button>
                                            )}

                                            {/* Attendance Controls */}
                                            <div className="flex items-center gap-2 pl-2 border-l border-white/10">
                                                <button
                                                    onClick={() => handleStatusUpdate(student.id, 'present')}
                                                    className={`p-3 rounded-xl transition-all ${student.status === 'present' ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20' : 'bg-white/5 text-white/20 hover:text-emerald-400 hover:bg-emerald-400/10'}`}
                                                    title="Mark Present"
                                                >
                                                    <CheckSquare className="w-6 h-6" />
                                                </button>

                                                <button
                                                    onClick={() => handleStatusUpdate(student.id, 'absent')}
                                                    className={`p-3 rounded-xl transition-all ${student.status === 'absent' ? 'bg-rose-500 text-white shadow-lg shadow-rose-500/20' : 'bg-white/5 text-white/20 hover:text-rose-400 hover:bg-rose-400/10'}`}
                                                    title="Mark Absent"
                                                >
                                                    <XSquare className="w-6 h-6" />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Recent Check-ins List */}
                    {/* Only show recent checkins that are NOT 'absent' if we want, or show all actions? user didn't specify. 
                        Let's keep recent checkins as 'Activity Log' basically. 
                        But the 'Recent' list in original code was just a view.
                        I'll keep it as is, but maybe filter out 'absent' if check_in_time is null?
                        Original logic: eq('date', today). order('check_in_time', false).
                        If check_in_time is null (absent), they might appear at end or beginning depending on sort nulls.
                        Let's verify logic of fetchRecentCheckIns. */}
                </div>

                {/* Staff Attendance Section */}
                <div className="glass-card rounded-[2.5rem] border border-white/10 p-8 flex flex-col h-[600px]">
                    <div className="flex items-center justify-between mb-8">
                        <h2 className="text-2xl font-black text-white uppercase tracking-tight flex items-center gap-3">
                            <Users className="w-6 h-6 text-emerald-400" />
                            {t('reception.coachAttendance') || 'Staff Attendance'}
                        </h2>
                        <div className="flex items-center gap-2">
                            <span className="px-3 py-1 bg-white/5 text-xs font-bold uppercase tracking-wider rounded-lg text-white/50">
                                {coachesList.filter(c => c.status === 'present').length} / {coachesList.length} Present
                            </span>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-3">
                        {loadingCoaches ? (
                            <div className="text-center py-20 text-white/30 uppercase tracking-widest font-bold">Loading...</div>
                        ) : coachesList.map(coach => (
                            <div key={coach.id}
                                className={`flex items-center justify-between p-4 rounded-2xl border transition-all 
                                    ${coach.status === 'present' ? 'bg-emerald-500/10 border-emerald-500/20' :
                                        coach.status === 'absent' ? 'bg-rose-500/5 border-rose-500/10' :
                                            'bg-white/5 border-white/10'}`}
                            >
                                <div className="flex items-center gap-4">
                                    <div className="relative">
                                        <div className="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center overflow-hidden">
                                            {coach.avatar_url ? (
                                                <img src={coach.avatar_url} alt="" className="w-full h-full object-cover" />
                                            ) : (
                                                <span className="font-black text-white/50">{coach.full_name[0]}</span>
                                            )}
                                        </div>
                                        <div className={`absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-[#0E1D21] 
                                            ${coach.status === 'present' ? 'bg-emerald-400' :
                                                coach.status === 'absent' ? 'bg-rose-500' : 'bg-white/20'}`}>
                                        </div>
                                    </div>
                                    <div>
                                        <p
                                            onClick={() => navigate(`/coaches/${coach.id}`)}
                                            className="font-bold text-white text-lg hover:text-primary cursor-pointer transition-colors"
                                        >
                                            {coach.full_name}
                                        </p>
                                        <div className="flex items-center gap-3 text-xs font-bold uppercase tracking-wider text-white/40">
                                            {coach.status === 'present' && (
                                                <span className="text-emerald-400 flex items-center gap-1">
                                                    <CheckCircle className="w-3 h-3" />
                                                    Present
                                                    {coach.checkInTime && (
                                                        <span className="ml-1 px-1.5 py-0.5 bg-emerald-500/10 rounded text-[10px] font-mono border border-emerald-500/20">
                                                            <StaffTimer startTime={coach.checkInTime} />
                                                        </span>
                                                    )}
                                                </span>
                                            )}
                                            {coach.status === 'absent' && (
                                                <span className="text-rose-400 flex items-center gap-1">
                                                    <XCircle className="w-3 h-3" /> Absent
                                                </span>
                                            )}
                                            {coach.status === 'pending' && <span>Offline</span>}
                                        </div>
                                        {/* Note Display */}
                                        {coach.note && editingNoteId !== coach.id && (
                                            <div className="mt-2 text-xs text-yellow-400/80 bg-yellow-400/10 px-2 py-1 rounded-md inline-flex items-center gap-1">
                                                <MessageSquare className="w-3 h-3" />
                                                {coach.note}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="flex items-center gap-2">
                                    {/* Note Input Area */}
                                    {editingNoteId === coach.id ? (
                                        <div className="flex items-center gap-2 mr-2 animate-in fade-in slide-in-from-right-4">
                                            <input
                                                autoFocus
                                                type="text"
                                                value={noteText}
                                                onChange={(e) => setNoteText(e.target.value)}
                                                placeholder="Add a note..."
                                                className="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-primary/50 w-48"
                                                onKeyDown={(e) => e.key === 'Enter' && handleSaveStaffNote(coach.id)}
                                            />
                                            <button
                                                onClick={() => handleSaveStaffNote(coach.id)}
                                                className="p-2 bg-emerald-500/20 text-emerald-400 rounded-lg hover:bg-emerald-500/30"
                                            >
                                                <Save className="w-4 h-4" />
                                            </button>
                                            <button
                                                onClick={() => setEditingNoteId(null)}
                                                className="p-2 bg-white/5 text-white/40 rounded-lg hover:bg-white/10"
                                            >
                                                <X className="w-4 h-4" />
                                            </button>
                                        </div>
                                    ) : (
                                        <button
                                            onClick={() => {
                                                setEditingNoteId(coach.id);
                                                setNoteText(coach.note || '');
                                            }}
                                            className={`p-3 rounded-xl transition-all ${coach.note ? 'text-yellow-400 bg-yellow-400/10' : 'text-white/20 bg-white/5 hover:text-white/60'}`}
                                            title="Add Note"
                                        >
                                            <MessageSquare className="w-5 h-5" />
                                        </button>
                                    )}

                                    {/* Attendance Controls */}
                                    <div className="flex items-center gap-2 pl-2 border-l border-white/10">
                                        <button
                                            onClick={() => handleStaffStatusUpdate(coach.id, 'present')}
                                            className={`p-3 rounded-xl transition-all ${coach.status === 'present' ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20' : 'bg-white/5 text-white/20 hover:text-emerald-400 hover:bg-emerald-400/10'}`}
                                            title="Mark Present"
                                        >
                                            <CheckSquare className="w-6 h-6" />
                                        </button>

                                        <button
                                            onClick={() => handleStaffStatusUpdate(coach.id, 'absent')}
                                            className={`p-3 rounded-xl transition-all ${coach.status === 'absent' ? 'bg-rose-500 text-white shadow-lg shadow-rose-500/20' : 'bg-white/5 text-white/20 hover:text-rose-400 hover:bg-rose-400/10'}`}
                                            title="Mark Absent"
                                        >
                                            <XSquare className="w-6 h-6" />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>


                {/* PT Attendance Section */}
                <div className="glass-card rounded-[2.5rem] border border-white/10 p-8 flex flex-col h-[600px]">
                    <div className="flex items-center justify-between mb-8">
                        <h2 className="text-2xl font-black text-white uppercase tracking-tight flex items-center gap-3">
                            <Dumbbell className="w-6 h-6 text-accent" />
                            {t('reception.ptSessions') || 'PT Sessions'}
                        </h2>
                        <div className="flex items-center gap-2">
                            <span className="px-3 py-1 bg-white/5 text-xs font-bold uppercase tracking-wider rounded-lg text-white/50">
                                {ptList.filter(s => s.status === 'present').length} Active
                            </span>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-3">
                        {loadingPt ? (
                            <div className="text-center py-20 text-white/30 uppercase tracking-widest font-bold">Loading...</div>
                        ) : ptList.length === 0 ? (
                            <div className="text-center py-20 opacity-30">
                                <Dumbbell className="w-12 h-12 mx-auto mb-4" />
                                <p className="uppercase tracking-widest font-bold">No Active Subscriptions</p>
                            </div>
                        ) : (
                            ptList.map(item => (
                                <div key={item.id}
                                    className={`flex items-center justify-between p-4 rounded-2xl border transition-all 
                                    ${item.status === 'present' ? 'bg-accent/10 border-accent/20' :
                                            item.status === 'completed' ? 'bg-white/5 border-white/5 opacity-60' :
                                                'bg-white/5 border-white/10'}`}
                                >
                                    <div className="flex items-center gap-4">
                                        <div className={`w-12 h-12 rounded-xl flex items-center justify-center overflow-hidden font-black text-white/50 text-xl
                                        ${item.status === 'present' ? 'bg-accent/20 text-accent' : 'bg-white/10'}`}>
                                            {item.displayName ? item.displayName[0] : '?'}
                                        </div>
                                        <div>
                                            <p className="font-bold text-white text-lg">
                                                {item.displayName}
                                            </p>
                                            <div className="flex items-center gap-3 text-xs font-bold uppercase tracking-wider text-white/40">
                                                <span className="flex items-center gap-1">
                                                    <Users className="w-3 h-3" />
                                                    {item.coachName || 'No Coach'}
                                                </span>
                                                {item.status === 'present' && (
                                                    <span className="text-accent flex items-center gap-1">
                                                        <Clock className="w-3 h-3 animate-pulse" /> In Session
                                                        {item.checkInTime && (
                                                            <span className="ml-1 px-1.5 py-0.5 bg-accent/10 rounded text-[10px] font-mono border border-accent/20">
                                                                <StaffTimer startTime={item.checkInTime} />
                                                            </span>
                                                        )}
                                                    </span>
                                                )}
                                            </div>
                                            <div className="mt-1 text-[10px] text-white/30 font-medium tracking-wider uppercase">
                                                {item.sessions_remaining} Sessions Left
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex items-center gap-2">
                                        {/* Attendance Controls */}
                                        <div className="flex items-center gap-2 pl-2 border-l border-white/10">
                                            {(item.status === 'pending' || item.status === 'absent') && item.sessions_remaining > 0 && (
                                                <button
                                                    onClick={() => handlePtStatusUpdate(item.id, item.sessions_remaining, 'present')}
                                                    className="p-3 rounded-xl bg-white/5 text-white/20 hover:text-accent hover:bg-accent/10 transition-all border border-white/5 hover:border-accent/20"
                                                    title="Start Session"
                                                >
                                                    <CheckSquare className="w-6 h-6" />
                                                </button>
                                            )}

                                            {item.status === 'present' && (
                                                <button
                                                    onClick={() => handlePtStatusUpdate(item.id, item.sessions_remaining, 'completed')}
                                                    className="p-3 rounded-xl bg-accent text-white shadow-lg shadow-accent/20 transition-all hover:bg-accent/80"
                                                    title="Complete Session"
                                                >
                                                    <CheckCircle className="w-6 h-6" />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )))}
                    </div>
                </div>

                {/* Modals */}
                {
                    showAddStudent && (
                        <AddStudentForm
                            onClose={() => setShowAddStudent(false)}
                            onSuccess={() => {
                                setShowAddStudent(false);
                                setRefreshTrigger(prev => prev + 1);
                                toast.success(t('reception.studentAdded') || 'Student added successfully');
                            }}
                        />
                    )
                }

                {
                    showAddPT && (
                        <AddPTSubscriptionForm
                            onClose={() => setShowAddPT(false)}
                            onSuccess={() => {
                                setShowAddPT(false);
                                toast.success(t('reception.subscriptionAdded'));
                            }}
                        />
                    )
                }
            </div>
        </div>
    );
}

function StaffTimer({ startTime }: { startTime: string }) {
    const [elapsed, setElapsed] = useState(0);

    useEffect(() => {
        const start = new Date(startTime).getTime();
        const update = () => {
            const now = new Date().getTime();
            setElapsed(Math.floor((now - start) / 1000));
        };
        update();
        const interval = setInterval(update, 1000);
        return () => clearInterval(interval);
    }, [startTime]);

    const h = Math.floor(elapsed / 3600);
    const m = Math.floor((elapsed % 3600) / 60);
    const s = elapsed % 60;

    return (
        <span>
            {h.toString().padStart(2, '0')}:{m.toString().padStart(2, '0')}:{s.toString().padStart(2, '0')}
        </span>
    );
}

